---
title: "Rocky River watershed predictions"
theme: sandstone
format:
  html:
    css: styles.css
    grid:
      sidebar-width: 0px
      margin-width: 0px
      body-width: 2500px
---


HydroATLAS data that can be used in gravel models to estimate gravel with the proper size for salmon spawning. Includes example predictions of gravel size.
Click on a reach to see the data for each segment. Links to download shapefiles are below map.

::: {.column-screen}
```{r, library}
#| include: false

pacman::p_load(shiny,
               bslib,
               ggplot2,
               ggtext,
               shinythemes,
               thematic,
               tidyverse,
               httr,
               leaflet,
               leafem,
               terra,
               htmltools,
               glue,
               cowplot,
               grDevices,
               leaflegend)
```

```{r, import}
#| include: false
# import layers
  ## river extent
  rocky_drainage <- vect("data/spatial data/rocky_watershed.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## all rivers
  rocky_river <- vect("data/spatial data/rocky_hydroatlas.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## lakes
  lakes <- vect("data/spatial data/rocky_lakes.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## data from river reaches sampled
  # field_reaches <- vect("data/spatial data/exploits_reaches_with_sites.shp") |>  
  #   project("EPSG:4326 - WGS 84")
  
  # import arrow
arrow <- "https://cdn.pixabay.com/photo/2013/07/12/17/54/arrow-152596_960_720.png"
```

```{r, predictions}
#| include: false
# use river reach data to predict outcomes

# values from Ky's presentation
ps <- 2650 # kg/m3, density of sediment
p <- 2000 # kg/m3, density of water
g <- 9.80665 # m/s2, acceleration by gravity
n <- 0.04 # channel roughness coefficient
t <- 0.04 # shields parameter

## predict responses based on data from field at each reach
rocky_river$width <- (rocky_river$ria_ha_csu/rocky_river$LENGTH_KM)*10

rocky_river$tb <- p*g*(n^(3/5))*((rocky_river$DIS_AV_CMS/rocky_river$width)^(3/5))*((rocky_river$sgr_dk_rav/10000)^(7/10))  

rocky_river$D50 <- (rocky_river$tb/((ps-p)*g*t))*1000 


```

```{r, palettes}
#| include: false
  # colour palette for discharge
  discharge.pal <- colorNumeric(c("#dfdce3", "#8900a8"), domain = rocky_river$DIS_AV_CMS, na.color = "transparent")
  
  # colour palette for legend so high numbers at top
   discharge.pal.leg <- colorNumeric(c("#8900a8", "#dfdce3"), domain = rocky_river$DIS_AV_CMS, na.color = "transparent")
  
  # colour palette for width
  width.pal <- colorNumeric(c("#f2ca97", "#d4021d"), domain = rocky_river$width, na.color = "transparent") # 
  
  # colour palette for legend so high numbers at top
  width.pal.leg <- colorNumeric(c("#d4021d", "#f2ca97"), domain = rocky_river$width, na.color = "transparent") # 
   
  #width.pal <- colorFactor(c("#f2ca97", "#d4021d"), domain = TN_river$width*1000, na.color = "transparent") use this function for any categorical data you want to include in the map
  
  # colour palette for stream gradient
  gradient.pal <- colorNumeric(c("white", "grey20", "black"), domain = rocky_river$sgr_dk_rav/10000, na.color = "transparent")
  
  # colour palette for legend so high numbers at top
  gradient.pal.leg <- colorNumeric(c("black", "grey20", "white"), domain = c(min(rocky_river$sgr_dk_rav/10000), median(rocky_river$sgr_dk_rav/10000), max(rocky_river$sgr_dk_rav/10000)), na.color = "transparent")  

  
  # colour palette for D50, with 16-64 green
  
 D50.pal <- colorNumeric(c("#e9c602","#e9c602", "#e9c602","#FD602F"), domain = c(0,16,64,176), na.color = "transparent")
 
D50.col <-  D50.pal(rocky_river$D50)
D50.col[rocky_river$D50 > 16 & rocky_river$D50 < 64] <- "#0E7329"

D50.col.leg <- D50.pal(seq(0, 176, by = 16))
D50.col.leg[seq(0, 176, by = 16) > 16 & seq(0, 176, by = 16) < 64] <- "#0E7329"

D50.pal.leg <- colorNumeric(rev(D50.col.leg), domain = c(0,176), na.color = "transparent")
```


```{r, popup_labels}
#| include: false
# adds information to popups for each reach wehn it is selected

  label_text <- glue("<b><u>{'Stream info:'}</u></b> <br/>",
"<b>Segment discharge: </b> {rocky_river$DIS_AV_CMS}<br/>",
"<b>Segment width: </b> {rocky_river$width}<br/>",
"<b>Segment gradient: </b> {rocky_river$sgr_dk_rav}<br/>",
"<b>Segment D50: </b> {rocky_river$D50}<br/>") |> 

  lapply(htmltools::HTML)
```

```{r, map}
#| echo: false

rocky_map <- leaflet(width = "100vw", height = "75vh", options = leafletOptions(zoomSnap = 0.25)) |> 
      addProviderTiles('Esri.WorldImagery') |> # adds base map

      # open map to this screen
      setView(-53.53256, 47.35, zoom = 10.5) |> 

      #can recenter to that location by clicking button
      addHomeButton(ext = c(-53.70243, 47.2, -53.36890, 47.5), position = "topleft", group = "Recenter") |> 

      # create layers to add vectors to
      addMapPane("drainage", zIndex = 410) |> 
      addMapPane("river", zIndex = 415) |> 
      addMapPane("data_D50", zIndex = 450) |> 
      addMapPane("data_disch", zIndex = 445) |> 
      addMapPane("data_width", zIndex = 440) |> 
      addMapPane("data_grad", zIndex = 435) |> 
      addMapPane("lakes", zIndex = 455) |>

      # add polygons and lines
      ## exploits drainage area
      addPolygons(data = rocky_drainage, color = "#236D9E", weight = 1.25, fillColor = "#236D9E", fillOpacity = 0.2, options = pathOptions(pane = "drainage")) |>
  
      ## rivers of the rocky
      addPolylines(data = rocky_river, color = "#236D9E", weight = 3/rocky_river$ORD_CLAS, options = pathOptions(pane = "river"), group = "exploits", opacity = 0.8) |>

        ### D50
      addPolylines(data = rocky_river, color = D50.col, weight = 3/rocky_river$ORD_CLAS, opacity = 1, options = pathOptions(pane = "data_D50"), group = "D50", popup = ~label_text) |>
      addLegendNumeric(pal = D50.pal.leg, values = rocky_river$D50, title = "D50 gravel size (mm)", position = 'topright', group = "D50", fillOpacity = 1, bins = 7, shape = "stadium", decreasing = TRUE, height = 150, width = 20) |> 
  
  
      ### discharge
      addPolylines(data = rocky_river, color = ~discharge.pal(rocky_river$DIS_AV_CMS), weight = 3/rocky_river$ORD_CLAS, opacity = 1, options = pathOptions(pane = "data_disch"), group = "Discharge", popup = ~label_text) |>
        addLegendNumeric(pal = discharge.pal.leg, values = rocky_river$DIS_AV_CMS, title = htmltools::HTML("Discharge (m<sup>3</sup>/s)"),position = 'topright', group = "Discharge", fillOpacity = 1, bins = 7, shape = "stadium", decreasing = TRUE , height = 150, width = 20 ) |> 
      # addLegend(pal = discharge.pal, values = rocky_river$DIS_AV_CMS,
      #           title = "Discharge (m<sup>3</sup>/s)",
      #           group = "Discharge", opacity = 1, bins = 7) |> 
  
      ### width
      addPolylines(data = rocky_river, color = ~width.pal(rocky_river$width), weight = 3/rocky_river$ORD_CLAS, opacity = 1, options = pathOptions(pane = "data_width"), group = "Width", popup = ~label_text) |>
          addLegendNumeric(pal = width.pal.leg, values = rocky_river$width, title = "Stream width (m)",position = 'topright', group = "Width", fillOpacity = 1, bins = 7, shape = "stadium", decreasing = TRUE, height = 150, width = 20 ) |> 
      # addLegend(pal = width.pal, values = rocky_river$width,
      #           title = "Stream width (m)",
      #           group = "Width", opacity = 1, bins = 7) |>
  
      ### gradient
      addPolylines(data = rocky_river, color = ~gradient.pal(rocky_river$sgr_dk_rav/10000), weight = 3/rocky_river$ORD_CLAS, opacity = 1, options = pathOptions(pane = "data_grad"), group = "Gradient", popup = ~label_text) |>
          addLegendNumeric(pal = gradient.pal.leg, values = rocky_river$sgr_dk_rav/10000, title = "Stream gradient",position = 'topright', group = "Gradient", fillOpacity = 1, bins = 7, shape = "stadium", decreasing = TRUE, height = 150, width = 20 ) |> 
  
      ## lakes of the exploits
      addPolygons(data = lakes, color = "#236D9E", stroke = FALSE, fillOpacity = 0.7, options = pathOptions(pane = "lakes"), group = "exploits") |>
  
      # ability to choose which layers to see
      addLayersControl(overlayGroups = c("D50", "Discharge", "Width", "Gradient"), position = "topleft", options = layersControlOptions(collapsed = F, autoZIndex = TRUE)) |>
  addScaleBar(position = "bottomleft") |> 
  addLogo(arrow)
  

rocky_map
```

\
HydroATLAS data:

[Download the Rocky River HydroATLAS data shapefile](https://github.com/emmwilson/NL_watersheds/blob/0d9a7a8e31f9d6fc5a61aac211dbf85ce949138c/data/spatial%20data/rocky_hydroatlas.shp?raw=true)

Linke, S., Lehner, B., Ouellet Dallaire, C., Ariwi, J., Grill, G., Anand, M., Beames, P., Burchard-Levine, V., Maxwell, S., Moidu, H., Tan, F., Thieme, M. (2019). Global hydro-environmental sub-basin and river reach characteristics at high spatial resolution. Scientific Data 6: 283. doi: https://doi.org/10.1038/s41597-019-0300-6

Lehner, B., Messager, M.L., Korver, M.C., Linke, S. (2022). Global hydro-environmental lake characteristics at high spatial resolution. Scientific Data 9: 351. doi: https://doi.org/10.1038/s41597-022-01425-z
:::