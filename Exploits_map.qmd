---
title: "Exploits River watershed predictions"
theme: sandstone
format:
  html:
    grid:
      sidebar-width: 10px
      margin-width: 10px
      body-width: 1900px
---

::: {.column-fill}
::: {.panel-tabset}

### Field data predictions

Predictions of invertebrate biomass and embededness for the sampled reaches of the Exploits watershed.

Click on a reach that has been sampled (highlighted based on legends) to see the predictions and underlying characteristics

```{r, library}
#| include: false

pacman::p_load(shiny,
               bslib,
               ggplot2,
               ggtext,
               shinythemes,
               thematic,
               tidyverse,
               httr,
               leaflet,
               leafem,
               terra,
               htmltools,
               glue,
               cowplot)
```

```{r, import}
#| include: false
# import layers
  ## river extent
  exploits_drainage <- vect("data/spatial data/exploits_watershed.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## all rivers
  exploits_river <- vect("data/spatial data/OrderSlopeSegJan22.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## lakes
  lakes <- vect("data/spatial data/Exploits_lakes.shp") |>  
    project("EPSG:4326 - WGS 84")
  
  ## data from river reaches sampled
  field_reaches <- vect("data/spatial data/exploits_reaches_with_sites.shp") |>  # to be updated with 2025 sites
    project("EPSG:4326 - WGS 84")
  
  
  # import arrow
arrow <- "https://cdn.pixabay.com/photo/2013/07/12/17/54/arrow-152596_960_720.png"
```


```{r, palettes}
#| include: false
 #colour palettes for predictions
  # invert.pal <- colorNumeric(c("#f47c3c", "#d9534f"), domain = predictions_reaches$invert, na.color = "transparent")
  # embed.pal <- colorNumeric(c("#e9c602", "#93c54b"), domain =  predictions_reaches$embed, na.color = "transparent")

  # colour palette for discharge
  discharge.pal <- colorNumeric(c("#dfdce3", "#8900a8"), domain = field_reaches$discharge_, na.color = "transparent")
  
  # colour palette for width
  width.pal <- colorNumeric(c("#f2ca97", "#d4021d"), domain = field_reaches$avg_bank_w, na.color = "transparent") # 
  
  #width.pal <- colorFactor(c("#f2ca97", "#d4021d"), domain = TN_river$width*1000, na.color = "transparent") use this function for any categorical data you want to include in the map
  
  # colour palette for stream gradient
  gradient.pal <- colorNumeric(c("white", "black"), domain = field_reaches$channel_gr, na.color = "transparent")  
  
  # colour palette for D50, with 16-64 green
  
 D50.pal <- colorNumeric(c("#e9c602","#e9c602", "#e9c602","#FD602F"), domain = c(0,16,64,640), na.color = "transparent")
 
D50.col <-  D50.pal(field_reaches$D50_pred)
D50.col[field_reaches$D50_pred >= 16 & field_reaches$D50_pred <= 64] <- "#0E7329"

D50.col.leg <- D50.pal(seq(0, 640, by = 16))
D50.col.leg[seq(0, 640, by = 16) >= 16 & seq(0, 640, by = 16) <= 64] <- "#0E7329"

D50.pal.leg <- colorNumeric(D50.col.leg, domain = c(0,640), na.color = "transparent")
```

```{r, popup_labels}
#| include: false
# adds information to popups for each reach when it is selected


  label_text <- glue("<b><u>{'Stream info:'}</u></b> <br/>",
"<b>Segment discharge: </b> {field_reaches$discharge_}<br/>",
"<b>Segment width: </b> {field_reaches$avg_bank_w}<br/>",
"<b>Segment gradient: </b> {field_reaches$channel_gr}<br/>",
"<b>Segment D50: </b> {field_reaches$D50_pred}<br/>") |> 
 
  lapply(htmltools::HTML)
```

```{r, map}
#| echo: false

exploits_map <- leaflet(mapId = "map_1",width = 1900, height = 2100) |> 
      addProviderTiles('Esri.WorldImagery') |> # adds base map

      # open map to this screen
      setView(-56.65499, 48.70449, zoom = 9) |> 
  
      #can recenter to that location by clicking button
      addHomeButton(ext = c(-58,48.3, -55.6,49.1), position = "topleft", group = "Recenter") |> 
      
      # create layers to add vectors to
      addMapPane("drainage", zIndex = 410) |> 
      addMapPane("river", zIndex = 415) |> 
      addMapPane("reaches", zIndex = 420) |> 
      addMapPane("lakes", zIndex = 425) |>
      
      # add polygons and lines
      ## exploits drainage area
      addPolygons(data = exploits_drainage, color = "#1f78b4", weight = 1.25, fillColor = "#1f78b4", fillOpacity = 0.2, options = pathOptions(pane = "drainage")) |>
  
      ## rivers of the exploits
      addPolylines(data = exploits_river, color = "#1f78b4", weight = 1.5, options = pathOptions(pane = "river"), group = "exploits", opacity = 1) |>
  
      ## lakes of the exploits
      addPolygons(data = lakes, color = "#1f78b4", stroke = FALSE, fillOpacity = 1, options = pathOptions(pane = "lakes"), group = "exploits") |>
  
      ## discharge
      addPolylines(data = field_reaches, color = ~discharge.pal(field_reaches$discharge_), weight = 4, options = pathOptions(pane = "reaches"), group = "Discharge", popup = ~label_text, opacity = 1) |> 
      addLegend(pal = discharge.pal, values = field_reaches$discharge_,
                title = "Discharge (m<sup>3</sup>/s)",
                group = "discharge", opacity = 1) |> 
  
      ## gradient
      addPolylines(data = field_reaches, color = ~gradient.pal(field_reaches$channel_gr), weight = 4, options = pathOptions(pane = "reaches"), group = "Gradient", popup = ~label_text, opacity = 1) |> 
      addLegend(pal = gradient.pal, values = field_reaches$channel_gr,
                title = "Stream gradient",
                group = "gradient", opacity = 1) |> 
  
        ## width
      addPolylines(data = field_reaches, color = ~width.pal(field_reaches$avg_bank_w), weight = 4, options = pathOptions(pane = "reaches"), group = "Width", popup = ~label_text, opacity = 1) |> 
      addLegend(pal = width.pal, values = field_reaches$avg_bank_w,
                title = "Stream width (m)",
                group = "width", opacity = 1) |> 
  
      ## D50
      addPolylines(data = field_reaches, color = D50.col, weight = 4, options = pathOptions(pane = "reaches"), group = "D50", popup = ~label_text, opacity = 1) |> 
      addLegend(pal = D50.pal.leg, values = field_reaches$D50_pred,
                title = "Predicted D50",
                group = "D50", opacity = 1) |> 
  
      # ability to choose which predictions to see
      addLayersControl(overlayGroups = c("Discharge", "Gradient", "Width","D50"), position = "topleft", options = layersControlOptions(collapsed = F)) |>
    #   htmlwidgets::onRender("
    #     function() {
    #         $('.leaflet-control-layers-overlays').prepend('<label style=\"text-align:left\">Available layers</label>');
    #     }
    # ")  |>
  
  addScaleBar(position = "bottomright") |> 
  addLogo(arrow)

exploits_map
```

### HydroATLAs predictions

```{r, importws}
#| include: false
# import layers
  ## river extent
  
  ## all rivers
  exploits_wsriver <- vect("data/spatial data/exploits_hydroatlas.shp") |>  
    project("EPSG:4326 - WGS 84")
```

```{r, predictionsws}
#| include: false
# use river reach data to predict outcomes

# values from Ky's presentation
ps <- 2650 # kg/m3, density of sediment
p <- 2000 # kg/m3, density of water
g <- 9.80665 # m/s2, acceleration by gravity
n <- 0.04 # channel roughness coefficient
t <- 0.04 # shields parameter

## predict responses based on data from field at each reach
exploits_wsriver$width <- (exploits_wsriver$ria_ha_csu/exploits_wsriver$LENGTH_KM)*10

exploits_wsriver$tb <- p*g*(n^(3/5))*((exploits_wsriver$DIS_AV_CMS/exploits_wsriver$width)^(3/5))*((exploits_wsriver$sgr_dk_rav/10000)^(7/10))  

exploits_wsriver$D50 <- (exploits_wsriver$tb/((ps-p)*g*t))*1000 

```

```{r, palettesws}
#| include: false
 #colour palettes for predictions
  # invert.pal <- colorNumeric(c("#f47c3c", "#d9534f"), domain = predictions_reaches$invert, na.color = "transparent")
  # embed.pal <- colorNumeric(c("#e9c602", "#93c54b"), domain =  predictions_reaches$embed, na.color = "transparent")

  # colour palette for discharge
  dischargews.pal <- colorNumeric(c("#dfdce3", "#8900a8"), domain = exploits_wsriver$DIS_AV_CMS, na.color = "transparent")
  
  # colour palette for width
  widthws.pal <- colorNumeric(c("#f2ca97", "#d4021d"), domain = exploits_wsriver$width, na.color = "transparent") # 
  
  #width.pal <- colorFactor(c("#f2ca97", "#d4021d"), domain = exploits_river$width*1000, na.color = "transparent") use this function for any categorical data you want to include in the map
  
  # colour palette for stream gradient
  gradientws.pal <- colorNumeric(c("white", "grey20", "black"), domain = c(min(exploits_wsriver$sgr_dk_rav/10000), median(exploits_wsriver$sgr_dk_rav/10000), max(exploits_wsriver$sgr_dk_rav/10000)), na.color = "transparent")  
  
  # colour palette for D50, with 16-64 green
  
 D50ws.pal <- colorNumeric(c("#e9c602","#e9c602", "#e9c602","#FD602F"), domain = c(0,16,64,800), na.color = "transparent")
 
D50ws.col <-  D50ws.pal(exploits_wsriver$D50)
D50ws.col[exploits_wsriver$D50 >= 16 & exploits_wsriver$D50 <= 64] <- "#0E7329"

D50ws.col.leg <- D50ws.pal(seq(0, 640, by = 16))
D50ws.col.leg[seq(0, 640, by = 16) >= 16 & seq(0, 640, by = 16) <= 64] <- "#0E7329"

D50ws.pal.leg <- colorNumeric(D50ws.col.leg, domain = c(0,640), na.color = "transparent")
```

```{r, popup_labelsws}
#| include: false
# adds information to popups for each reach wehn it is selected

  label_textws <- glue("<b><u>{'Stream info:'}</u></b> <br/>",
"<b>Segment discharge: </b> {exploits_wsriver$DIS_AV_CMS}<br/>",
"<b>Segment width: </b> {exploits_wsriver$width}<br/>",
"<b>Segment gradient: </b> {exploits_wsriver$sgr_dk_rav}<br/>",
"<b>Segment D50: </b> {exploits_wsriver$D50}<br/>") |> 
 
  lapply(htmltools::HTML)
```

```{r, mapws}
#| echo: false
#| warning: false
  
exploits_mapws <- leaflet(mapId = "map_2", width = 1900, height = 2100) |> 
      addProviderTiles('Esri.WorldImagery') |> # adds base map

      # open map to this screen
      setView(-56.65499, 48.70449, zoom = 9) |> 
  
      #can recenter to that location by clicking button
      addHomeButton(ext = c(-58,48.3, -55.6,49.1), position = "topleft", group = "Recenter") |> 
      
      # create layers to add vectors to
      addMapPane("drainage", zIndex = 410) |> 
      addMapPane("river", zIndex = 415) |> 
      addMapPane("reaches", zIndex = 420) |> 
      addMapPane("lakes", zIndex = 425) |>
      
      # add polygons and lines
      ## exploits drainage area
      addPolygons(data = exploits_drainage, color = "#1f78b4", weight = 1.25, fillColor = "#1f78b4", fillOpacity = 0.2, options = pathOptions(pane = "drainage")) |>
  
      ## rivers of the rocky
      addPolylines(data = exploits_wsriver, color = "#1f78b4", weight = 1.5, options = pathOptions(pane = "river"), group = "exploits", opacity = 1) |>

      ### discharge
      addPolylines(data = exploits_wsriver, color = ~dischargews.pal(exploits_wsriver$DIS_AV_CMS), weight = 3/exploits_wsriver$ORD_CLAS, opacity = 1, options = pathOptions(pane = "reaches"), group = "Discharge", popup = ~label_textws) |>
      addLegend(pal = dischargews.pal, values = exploits_wsriver$DIS_AV_CMS,
                title = "Discharge (m<sup>3</sup>/s)",
                group = "Discharge", opacity = 1, bins = 7) |> 
  
      ### width
      addPolylines(data = exploits_wsriver, color = ~widthws.pal(exploits_wsriver$width), weight = 3/exploits_wsriver$ORD_CLAS, opacity = 1, options = pathOptions(pane = "reaches"), group = "Width", popup = ~label_textws) |>
      addLegend(pal = widthws.pal, values = exploits_wsriver$width,
                title = "Stream width (m)",
                group = "Width", opacity = 1, bins = 7) |>
  
      ### gradient
      addPolylines(data = exploits_wsriver, color = ~gradientws.pal(exploits_wsriver$sgr_dk_rav/10000), weight = 3/exploits_wsriver$ORD_CLAS, opacity = 1, options = pathOptions(pane = "reaches"), group = "Gradient", popup = ~label_textws) |>
      addLegend(pal = gradientws.pal, values = exploits_wsriver$sgr_dk_rav/10000,
                title = "Stream gradient",
                group = "Gradient", opacity = 1, bins = 7) |>
  
      ### D50
      addPolylines(data = exploits_wsriver, color = D50ws.col, weight = 3/exploits_wsriver$ORD_CLAS, opacity = 1, options = pathOptions(pane = "reaches"), group = "D50", popup = ~label_text) |>
      addLegend(pal = D50ws.pal.leg, values = exploits_wsriver$D50,
                title = "D50 gravel size (mm)",
                group = "D50", opacity = 1, bins = 20) |>
  
      ## lakes of the exploits
      addPolygons(data = lakes, color = "#1f78b4", stroke = FALSE, fillOpacity = 1, options = pathOptions(pane = "lakes"), group = "exploits") |>
  
      # ability to choose which predictions to see
      addLayersControl(overlayGroups = c("Discharge", "Width", "Gradient", "D50"), position = "topleft", options = layersControlOptions(collapsed = F)) |>
    #   htmlwidgets::onRender("
    #     function() {
    #         $('.leaflet-control-layers-overlays').prepend('<label style=\"text-align:left\">Available layers</label>');
    #     }
    # ")  |>
  
  addScaleBar(position = "bottomright") |> 
  addLogo(arrow)

exploits_mapws
```

HydroATLAS data:

Linke, S., Lehner, B., Ouellet Dallaire, C., Ariwi, J., Grill, G., Anand, M., Beames, P., Burchard-Levine, V., Maxwell, S., Moidu, H., Tan, F., Thieme, M. (2019). Global hydro-environmental sub-basin and river reach characteristics at high spatial resolution. Scientific Data 6: 283. doi: https://doi.org/10.1038/s41597-019-0300-6
Lehner, B., Messager, M.L., Korver, M.C., Linke, S. (2022). Global hydro-environmental lake characteristics at high spatial resolution. Scientific Data 9: 351. doi: https://doi.org/10.1038/s41597-022-01425-z

:::
:::